---
title: "K3 article"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r}
library(ggplot2)
library(testthat)
```

## Preparation

```{r}
get_verdict <- function(p_value, alpha) {
  if (p_value < alpha) {
    return ("Different distributions")
  }
  "Same distributions"
}
```

```{r}
t <- wilcox.test(
  x = seq(from = 1, to = 10, length.out = 10),
  y = seq(from = 1, to = 10, length.out = 20), 
  alternative = "two.sided"
)
expect_equal(
  get_verdict(p_value = t$p.value, alpha = 0.05),
  "Same distributions"
)
```

```{r}
t <- wilcox.test(
  x = seq(from = 1, to = 5, length.out = 10),
  y = seq(from = 5, to = 10, length.out = 20), 
  alternative = "two.sided"
)
expect_equal(
  get_verdict(p_value = t$p.value, alpha = 0.05),
  "Different distributions"
)
```

## Data

```{r}
filenames <- k3reviews::get_all_song_filenames()
df <- k3reviews::get_songs_ratings(filenames)
```

Plots:

```{r}
ggplot(na.omit(df), aes(x = formation)) +
  geom_histogram(stat = "count") +
  ggsave("formations.png", width = 7, height = 7)
```

```{r}
df_valid <- df
df_valid$rating <- as.numeric(df$rating)
df_valid <- na.omit(df_valid)
df_valid <- df_valid[ nchar(df_valid$formation) == 3, ]


ggplot(df_valid, aes(x = reviewer , y = rating)) +
  geom_boxplot() +
  ggsave("ratings_per_reviewer.png", width = 7, height = 7)
```

```{r}
ggplot(df_valid, aes(x = formation , y = rating)) +
  geom_boxplot() +
  ggsave("ratings_per_formation.png", width = 7, height = 7)
```

```{r}
ggplot(df_valid, aes(x = formation , y = rating, fill = reviewer)) +
  geom_boxplot() +
  ggsave("ratings_per_formation_per_reviewer.png", width = 7, height = 7)
```

Real data:

```{r}
set.seed(42)

ratings_1 <- df_valid[df_valid$formation == "KKK", ]$rating
ratings_2 <- df_valid[df_valid$formation == "HKM", ]$rating
```

## Stats

```{r}
alpha <- 0.05
```

```{r}
t <- wilcox.test(
  x = ratings_1, 
  y = ratings_2, 
  alternative = "two.sided"
)
m <- matrix(
  data = c(
    "p_value", t$p.value,
    "alternative", t$alternative,
    "method", t$method,
    "data.name", t$data.name,
    "verdict", get_verdict(p_value = t$p.value, alpha = alpha)
  ),
  ncol = 2,
  byrow = TRUE
)
colnames(m) <- c("parameter", "value")
df <- tibble::as_tibble(m)
names(df) <- c("parameter", "value")
write.csv(df, "stats.csv", row.names = FALSE)
knitr::kable(df)
```

## Plot

```{r}
df <- tibble::tibble(
  formation = c(
    rep(1, length(ratings_1)), 
    rep(2, length(ratings_2))
  ),
  rating = c(ratings_1, ratings_2)
)
df$formation <- as.factor(df$formation)
ggplot(df, aes(x = formation, y = rating)) + 
  geom_boxplot() +
  scale_y_continuous(
    limits = c(1, 10), 
    breaks = seq(1, 10)
  ) +
  ggsave("figure_1.png", width = 7, height = 7)
```

## TODO
